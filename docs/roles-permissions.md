# 角色权限管理文档

**版本**: v1.0
**最后更新**: 2025-12-12
**负责人**: 系统架构师

## 概述

本文档定义了PayrollMaster系统中所有角色的权限矩阵和访问控制规则。系统采用基于角色的访问控制（RBAC）模型，确保用户只能访问被授权的功能模块。

## 角色定义

### 1. 系统管理员 (admin)
- **职责**: 拥有系统所有权限，负责系统配置、用户管理和数据备份
- **权限范围**: 系统全部功能
- **典型用户**: IT部门、系统维护人员

### 2. 职工调配管理员 (staff-admin)
- **职责**: 负责职工单位调动、岗位变动业务管理
- **权限范围**: 职工调配相关功能 + 用户管理权限
- **典型用户**: 人事部门调配专员

### 3. 职工考勤管理员 (attendance)
- **职责**: 负责职工各项出勤数据管理和维护
- **权限范围**: 考勤管理相关功能
- **典型用户**: 人事部门考勤专员

### 4. 社保管理员 (security)
- **职责**: 负责职工社保核算、提报、修改等社保相关业务
- **权限范围**: 社保管理相关功能
- **典型用户**: 人事部门社保专员

### 5. 财务管理员 (finance)
- **职责**: 负责职工个人所得税计算及提报
- **权限范围**: 税务管理相关功能
- **典型用户**: 财务部门税务专员

### 6. 单位薪资核算员 (payroll)
- **职责**: 负责本单位薪资数据提报及核算任务
- **权限范围**: 薪资计算和本单位数据管理
- **典型用户**: 各单位薪资核算专员

### 7. 普通员工 (employee) [未来版本]
- **职责**: 查看个人信息、出勤情况、薪资情况
- **权限范围**: 仅限本人数据
- **当前状态**: 暂未实现，在未来版本中开发

## 角色权限矩阵

| 功能模块 | 系统管理员 | 职工调配管理员 | 职工考勤管理员 | 社保管理员 | 财务管理员 | 单位薪资核算员 |
|:--------|:---------:|:-------------:|:-------------:|:---------:|:---------:|:-------------:|
| **用户管理** | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ |
| **职工银行卡号维护** | ✓ | ✗ | ✗ | ✗ | ✓ | ✓ |
| **薪资规则配置** | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ |
| **职工出勤管理** | ✓ | ✗ | ✓ | ✗ | ✗ | ✗ |
| **职工社保管理** | ✓ | ✗ | ✗ | ✓ | ✗ | ✗ |
| **职工个人所得税** | ✓ | ✗ | ✗ | ✗ | ✓ | ✗ |
| **薪资计算** | ✓ | ✗ | ✗ | ✗ | ✗ | ✓ |
| **查看所有薪资** | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ |
| **查看本单位薪资** | ✓ | ✗ | ✗ | ✗ | ✗ | ✓ |
| **单位薪资报表导出** | ✓ | ✗ | ✗ | ✗ | ✗ | ✓ |
| **数据备份** | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ |

## 权限说明

### 核心权限详解

#### 用户管理
- 创建/编辑/删除用户账号
- 分配和修改用户角色
- 重置用户密码
- 禁用/启用用户账号

#### 职工银行卡号维护
- 查看职工银行卡号信息
- 更新职工银行卡号
- 维护银行卡号变更历史

#### 薪资规则配置
- 创建/编辑薪资计算规则
- 设置奖金、扣款、加班费等参数
- 配置税率和社保比例
- 规则生效时间管理

#### 职工出勤管理
- 录入职工出勤数据
- 修改出勤记录
- 处理请假、加班申请
- 生成出勤统计报表

#### 职工社保管理
- 管理职工社保账户信息
- 调整社保缴费基数
- 处理社保转移和停缴
- 生成社保缴费报表

#### 职工个人所得税
- 配置个税计算规则
- 计算职工个人所得税
- 生成个税申报表
- 维护专项附加扣除

#### 薪资计算
- 执行薪资计算任务
- 查看计算结果和明细
- 重新计算和修订
- 计算历史记录

#### 查看薪资
- **查看所有薪资**: 系统所有职工的薪资数据
- **查看本单位薪资**: 仅限当前用户所在单位的职工薪资

#### 报表导出
- 导出Excel格式报表
- 自定义报表字段
- 按部门/时间筛选导出
- 导出历史记录

#### 数据备份
- 创建数据备份
- 恢复历史备份
- 备份文件管理
- 备份计划配置

## 数据访问范围

### 范围定义
- **系统级**: 系统管理员可访问所有数据
- **单位级**: 单位薪资核算员仅可访问本单位数据
- **个人级**: 普通员工仅可访问个人数据（未来版本）

### 数据隔离规则
1. 不同单位的数据严格隔离
2. 敏感数据（如银行卡号）需要特定权限才能查看
3. 所有数据访问都有审计日志记录

## 权限继承

```
系统管理员 (顶级权限)
├── 拥有所有权限
└── 可授权给其他角色

其他角色 (平级权限)
├── 职工调配管理员: 用户管理 + 调配管理
├── 职工考勤管理员: 考勤管理
├── 社保管理员: 社保管理
├── 财务管理员: 税务管理
└── 单位薪资核算员: 本单位薪资管理
```

## 特殊权限规则

### 1. 权限叠加
- 系统管理员拥有所有权限
- 其他角色权限独立，无叠加关系

### 2. 临时权限
- 支持临时授权机制（未来版本）
- 权限过期自动回收

### 3. 审批流程
- 敏感操作需要上级审批
- 系统记录审批历史

## API权限控制

### 端点权限检查
所有API端点都需要进行权限检查：

```python
# 示例：薪资计算API
@require_role(['admin', 'payroll'])
def calculate_payroll():
    # 如果是payroll，只能计算本单位数据
    # 如果是admin，可以计算所有数据
    pass

# 示例：用户管理API
@require_role(['admin', 'staff-admin'])
def create_user():
    # 只有admin和职工调配管理员可以创建用户
    pass
```

### 前端路由守卫
前端需要实现基于角色的路由守卫：

```typescript
// 示例路由配置
const routes = [
  {
    path: '/payroll/calculate',
    component: PayrollCalculation,
    requiredRoles: ['admin', 'payroll']
  },
  {
    path: '/users',
    component: UserManagement,
    requiredRoles: ['admin', 'staff-admin']
  }
];
```

## 数据库设计

### User表角色字段
```sql
ALTER TABLE users
ADD COLUMN role ENUM(
  'admin',
  'staff-admin',
  'attendance',
  'security',
  'finance',
  'payroll',
  'employee'
) NOT NULL DEFAULT 'employee';
```

### 权限检查中间件
```python
class RoleBasedAccessControl:
    def __init__(self, user_role: str, department_id: str):
        self.user_role = user_role
        self.department_id = department_id

    def check_permission(self, resource: str, action: str) -> bool:
        """检查用户是否有权限执行特定操作"""
        # 实现权限检查逻辑
        pass

    def filter_data_by_scope(self, data: QuerySet) -> QuerySet:
        """根据用户权限范围过滤数据"""
        # 实现数据范围过滤逻辑
        pass
```

## 审计日志

### 记录内容
- 用户ID和角色
- 访问的资源
- 执行的操作
- 时间戳
- IP地址
- 结果（成功/失败）

### 示例日志
```
2025-12-12 10:30:45 | User: zhangsan | Role: payroll | Action: 计算薪资 | Resource: /api/v1/calculate | Result: SUCCESS
2025-12-12 10:31:02 | User: lisi | Role: attendance | Action: 修改出勤 | Resource: /api/v1/attendance/update | Result: FAILED (无权限)
```

## 未来扩展

### 计划中的功能
1. **临时权限**: 支持临时授权和自动过期
2. **权限审批**: 敏感操作需要上级审批
3. **部门层级**: 支持多级部门权限管理
4. **数据脱敏**: 敏感数据自动脱敏显示
5. **操作留痕**: 详细记录所有数据变更

### 角色扩展
- 审计员: 专门负责审计和合规检查
- 临时用户: 短期访问权限
- 外部用户: 供应商、合作伙伴访问

## 变更记录

| 版本 | 日期 | 变更内容 | 负责人 |
|:----:|:----:|:--------|:------|
| v1.0 | 2025-12-12 | 初始版本，定义6个核心角色 | 系统架构师 |

## 相关文档

- [API文档](./contracts/api.md)
- [数据模型](./model.md)
- [功能规格说明书](../specs/spec.md)
- [任务清单](../specs/tasks.md)
