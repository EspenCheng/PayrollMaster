# Feature Specification: PayrollMaster薪资自动核算系统

**Feature Branch**: `001-payroll-calculation-system`
**Created**: 2025-12-07
**Status**: Draft
**Input**: User description: "你是一位资深全栈架构专家。你的任务是构建一个完整的、可用于生产环境的薪资自动核算Web应用程序。我已经为项目命名：PayrollMaster。当前已经在该项目目录中。项目需要使用Excel表格导入基础数据，最终按照我的需求导出薪资计算结果。生成所有必要的源代码文件,按文件路径清晰组织。确保代码健壮,处理CORS,包含必要的导入,并使用现代Web开发的最佳实践。"

## User Scenarios & Testing

### User Story 1 - Excel数据导入 (Priority: P1)

作为薪资管理员，我需要上传符合指定格式的Excel表格，包含系统所需的员工基础数据，以便系统能够读取并存储这些数据用于后续的薪资计算。

**Why this priority**: 薪资计算依赖于准确的员工基础数据，这是整个系统的基础功能。没有数据导入，系统无法进行任何薪资计算工作。

**Independent Test**: 可以通过上传标准格式的Excel文件并验证数据是否正确解析和显示在系统中来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 用户访问系统首页，**When** 点击"导入Excel"按钮并选择包含员工数据的Excel文件，**Then** 系统成功解析文件并显示员工数据列表
2. **Given** 用户上传格式错误的Excel文件，**When** 系统检测到文件格式不符，**Then** 显示友好的错误提示并指导用户如何修正
3. **Given** 用户上传空白的Excel文件，**When** 系统检测到无有效数据，**Then** 提示用户文件为空并要求重新选择
4. **Given** 用户上传包含重复员工ID的文件，**When** 系统检测到重复数据，**Then** 提示用户处理重复数据（覆盖或跳过）

---

### User Story 2 - 薪资计算配置 (Priority: P1)

作为薪资管理员，我需要配置薪资计算规则，以便系统能够根据这些规则自动计算每个员工的最终薪资。

**Why this priority**: 薪资计算规则是企业薪资管理的核心，不同企业有不同的计算标准。可配置的规则确保系统能够适应各种企业的需求。

**Independent Test**: 可以通过配置各种薪资计算规则并查看系统是否能够正确应用这些规则进行计算来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 系统已导入员工数据，**When** 管理员在配置页面设置奖金计算规则和扣款项目，**Then** 系统保存配置并在计算时应用这些规则
2. **Given** 系统已导入员工数据，**When** 管理员配置其他薪资计算参数（如加班费计算方式），**Then** 系统保存配置并在计算时应用这些参数
3. **Given** 管理员配置了奖金计算规则（如按基本薪资的10%），**When** 系统执行薪资计算时，**Then** 自动计算并添加奖金到员工薪资中
4. **Given** 管理员设置扣款项目（如迟到扣款、病假扣款），**When** 系统执行薪资计算时，**Then** 根据考勤数据自动扣除相应金额
5. **Given** 管理员修改了计算规则，**Then** 系统提供预览功能，展示新规则对现有数据的影响

---

### User Story 3 - 自动薪资计算 (Priority: P1)

作为薪资管理员，我需要系统根据导入的员工数据和配置的薪资规则，自动计算每个员工的应发薪资、扣除项目和实发薪资，并生成详细的薪资计算明细。

**Why this priority**: 自动计算是系统的核心价值，它将繁琐的人工计算工作自动化，确保计算准确性和效率。这是系统存在的根本原因。

**Independent Test**: 可以通过执行薪资计算并验证计算结果是否准确（基于已知的输入数据和计算规则）来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 系统已导入员工数据和配置计算规则，**When** 管理员点击"执行薪资计算"按钮，**Then** 系统计算每个员工的应发薪资、扣除项目和实发薪资
2. **Given** 员工有多条考勤记录，**When** 系统计算薪资时，**Then** 正确处理所有考勤数据并计算相应的扣款或加班费
3. **Given** 员工数据不完整（如缺少必要字段），**When** 系统执行计算时，**Then** 跳过该员工并显示错误提示
4. **Given** 薪资计算过程中发现异常数据，**Then** 系统暂停计算并高亮显示问题数据，等待管理员确认

---

### User Story 4 - 计算结果预览与确认 (Priority: P2)

作为薪资管理员，我需要预览薪资计算结果，包括每个员工的详细计算明细，以便在最终确认前检查数据准确性。

**Why this priority**: 在实际发放薪资前进行最终检查是必要的，这可以防止错误计算导致的薪资纠纷，保护企业和员工的利益。

**Independent Test**: 可以通过执行计算后查看详细结果页面并验证计算逻辑是否正确来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 薪资计算已完成，**When** 管理员查看计算结果页面，**Then** 显示每个员工的详细薪资明细（基本薪资、奖金、扣除、实发等）
2. **Given** 管理员发现计算错误，**Then** 可以返回修改配置或数据，然后重新执行计算
3. **Given** 管理员需要比较不同计算方案，**Then** 系统支持保存多个计算版本并进行比较
4. **Given** 管理员确认计算结果无误，**Then** 可以标记结果为"已确认"状态

---

### User Story 5 - 薪资报表导出 (Priority: P2)

作为薪资管理员，我需要将薪资计算结果导出为Excel报表，以便用于薪资发放、财务审计和员工查询。

**Why this priority**: 导出功能使薪资数据可以用于其他业务流程，如财务系统对接、银行代发、员工工资条发放等。标准化报表格式便于跨系统使用。

**Independent Test**: 可以通过导出功能生成Excel文件并验证文件内容是否包含完整的薪资数据和正确的格式来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 薪资计算结果已确认，**When** 管理员点击"导出报表"按钮，**Then** 系统生成包含所有员工薪资数据的Excel文件
2. **Given** 管理员需要导出员工基础信息报表，**When** 点击导出按钮，**Then** 系统生成基于 `dataExportReport.xlsx` 模板的文件，包含员工基础信息
3. **Given** 管理员需要导出薪资计算结果报表，**When** 点击导出按钮，**Then** 系统生成基于 `payrollCalculationResultExportReport.xlsx` 模板的文件，包含 payrollCalculationResult 工作表
4. **Given** 管理员需要导出特定格式的报表，**Then** 系统根据预定义的报表模板生成相应格式的Excel文件
5. **Given** 管理员需要导出特定部门的报表，**Then** 系统支持按部门筛选并导出相应数据
6. **Given** 导出的Excel文件，**Then** 文件包含完整的薪资计算明细，支持进一步编辑和处理
7. **Note**: 模板文件基于用户提供的参考文件（位于 `C:\Users\Espen\Desktop\`）进行优化

---

### User Story 6 - 用户认证与权限管理 (Priority: P3)

作为系统管理员，我需要管理用户账号和访问权限，确保只有授权人员能够访问薪资数据和执行敏感操作。

**Why this priority**: 薪资数据涉及敏感信息，需要严格的访问控制。不同角色（如系统管理员、各单位薪资核算员）应有不同的权限级别。

**Independent Test**: 可以通过创建不同权限的用户账号并验证各账号只能访问其授权范围内的功能来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 系统管理员账号，**When** 创建新用户账号并分配角色，**Then** 用户只能访问被授权的功能模块
2. **Given** 各单位薪资核算员账号，**When** 尝试访问薪资计算配置页面，**Then** 系统拒绝访问并提示权限不足
3. **Given** 用户输入正确登录凭证，**Then** 系统验证身份并建立安全会话
4. **Given** 用户会话超时，**Then** 系统自动注销并要求重新登录

---

### User Story 7 - 数据备份与恢复 (Priority: P3)

作为系统管理员，我需要定期备份薪资数据，并能够在需要时恢复数据，以防止数据丢失。

**Why this priority**: 薪资数据是企业的重要资产，必须确保数据安全。备份和恢复机制保护数据免受意外删除、系统故障等威胁。

**Independent Test**: 可以通过执行数据备份并模拟数据丢失场景，然后使用备份数据进行恢复来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 系统包含完整的薪资数据，**When** 管理员执行备份操作，**Then** 系统生成完整的数据备份文件
2. **Given** 数据备份文件已生成，**When** 管理员执行恢复操作，**Then** 系统恢复到备份时的状态
3. **Given** 备份过程中发生错误，**Then** 系统记录错误并提示管理员重试或检查存储空间
4. **Given** 管理员需要查看备份历史，**Then** 系统显示所有历史备份记录和恢复点

---

### Edge Cases

- Excel文件包含非标准字符或编码时如何处理？
- 同时有多个用户尝试执行薪资计算时如何处理并发？
- 计算过程中断网或服务器故障如何保证数据一致性？
- 超大数据量（如10万员工）时系统性能如何保证？
- 如何处理跨月或跨年的薪资计算？

## Requirements

### Functional Requirements

- **FR-001**: 系统必须支持上传Excel文件（.xlsx、.xls格式）并解析员工基础数据
- **FR-002**: 系统必须能够验证Excel文件格式和数据完整性，显示详细的错误信息
- **FR-003**: 系统必须提供薪资计算规则配置界面，支持奖金、扣款、加班费等参数设置
- **FR-004**: 系统必须支持多种薪资计算规则，包括固定金额、百分比计算、条件判断等
- **FR-005**: 系统必须能够根据导入的数据和配置规则，自动计算每个员工的应发薪资和实发薪资
- **FR-006**: 系统必须生成详细的薪资计算明细，包含每个计算步骤和依据
- **FR-007**: 系统必须提供薪资计算结果的预览功能，允许管理员在确认前检查数据
- **FR-008**: 系统必须支持将薪资计算结果导出为Excel文件，包含多种报表格式
  - 基于用户提供的参考文件设计：
    - `dataExportReport.xlsx`：员工基础信息导出表
    - `payrollCalculationResultExportReport.xlsx`：薪资计算结果导出表（payrollCalculationResult工作表）
- **FR-009**: 系统必须支持用户认证和基于角色的权限管理
- **FR-010**: 系统必须提供数据备份和恢复功能，确保数据安全
- **FR-011**: 系统必须处理CORS问题，允许前端跨域访问API
- **FR-012**: 系统必须实现输入验证，防止SQL注入、XSS等安全漏洞
- **FR-013**: 系统必须记录关键操作日志，支持审计追踪
- **FR-014**: 系统必须支持并发处理，避免数据竞争和不一致
- **FR-015**: 系统必须提供友好的错误提示和用户指导信息

### Key Entities

- **员工数据**: 包含员工ID、姓名、部门、职位、基本薪资、考勤记录等基础信息
- **薪资计算规则**: 包含奖金计算方式、扣款项目、加班费计算、计算公式等配置
- **薪资计算结果**: 包含每个员工在特定周期内的详细薪资明细和最终实发金额
- **用户账号**: 包含用户信息、角色权限、登录凭证等认证相关数据
- **系统日志**: 记录用户操作、系统事件、错误信息等，用于审计和问题追踪
- **数据备份**: 包含历史数据的备份文件，用于数据恢复和灾难恢复

### Excel 表格文件

**参考文件** (位于 `C:\Users\Espen\Desktop\`):
- **数据导入参考**: `dataSubmissionReport.xlsx` - 用于导入员工基础数据和考勤数据
- **数据导出参考**: `dataExportReport.xlsx` - 用于导出员工基础信息
- **薪资核算结果导出参考**: `payrollCalculationResultExportReport.xlsx` - 用于导出薪资计算结果（包含 payrollCalculationResult 工作表）

**模板文件** (位于项目 `excel-templates` 目录):
- 模板文件将基于上述参考文件进行优化和调整

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用户能够在5分钟内完成标准Excel文件的导入和数据验证
- **SC-002**: 系统能够处理包含1000名员工的Excel文件，导入时间不超过30秒
- **SC-003**: 薪资计算准确率达到100%（基于人工验证的测试用例）
- **SC-004**: 薪资计算过程在1000名员工规模下不超过60秒完成
- **SC-005**: 用户界面操作直观，90%的新用户能够在10分钟内独立完成完整薪资核算流程
- **SC-006**: 系统支持导出功能，生成的Excel文件格式正确，数据完整，可被Excel 2016及以上版本正常打开
- **SC-007**: 用户认证和权限控制机制确保未授权访问成功率为0%
- **SC-008**: 数据备份和恢复功能经过验证，能够在数据丢失场景下100%恢复数据
- **SC-009**: 系统在浏览器兼容性方面，支持Chrome、Firefox、Safari、Edge四大主流浏览器
- **SC-010**: 系统错误处理友好，所有错误场景都有明确的提示信息和解决建议

## Clarifications

### Session 2025-12-07

- **Q**: 是否需要包含个人所得税和社保计算功能？
- **A**: 系统包含个人所得税和个人社保公积金的核算功能：
  - 个人所得税：作为单独扣款项，在实领工资计算中扣除
  - 个人社保公积金：包含养老保险、医疗保险、失业保险、住房公积金等
  - 个人所得税计算：基于应领工资扣除各项社保后计算
  - 实领工资 = 应领工资 - 个人代扣代缴合计 - 个人所得税 + 独生子女费 + 女工卫生费

- **Q**: Excel表格的具体格式和字段要求是什么？
- **A**: 系统将使用预定义的变量映射文档和计算规则文档，确保数据字段和计算逻辑的准确性。

- **Q**: 薪资核算变量和计算规则如何管理？
- **A**: 已在项目中建立规则管理目录 `specs/001-payroll-calculation-system/rules/`，包含 `44-薪资变量定义.md`（变量定义文档）和 `43-薪资计算逻辑.md`（计算逻辑文档），开发时必须严格遵循这两个文档的定义。

- **Q**: Excel表格模板如何管理？
- **A**: Excel表格模板文件统一管理：
  - **模板目录**: `specs/001-payroll-calculation-system/excel-templates/`，包含导入模板(import/)、导出模板(export/)和Web展示结构(web-display/)三个子目录
  - **参考文件**: 用户提供的原始表格文件位于 `C:\Users\Espen\Desktop\` 目录下：
    - `dataSubmissionReport.xlsx` - 数据导入参考
    - `dataExportReport.xlsx` - 数据导出参考
    - `payrollCalculationResultExportReport.xlsx` - 薪资核算结果导出参考
  - 详细定义了数据导入格式、导出格式和Web界面展示结构，确保Excel导入导出与Web展示的数据一致性。

- **Q**: 实际的Excel模板文件在哪里？
- **A**: 用户提供了三个Excel参考文件：
  - 数据导入参考：`dataSubmissionReport.xlsx`（位于 `C:\Users\Espen\Desktop\`）
  - 数据导出参考：`dataExportReport.xlsx`（位于 `C:\Users\Espen\Desktop\`）
  - 薪资核算结果导出参考：`payrollCalculationResultExportReport.xlsx`（位于 `C:\Users\Espen\Desktop\`，包含 payrollCalculationResult 工作表）
  - 这些文件作为参考，模板文件应存放在项目的 `excel-templates` 目录中

- **Q**: 哪些字段被删除？
- **A**: 根据用户要求，已删除以下字段：育儿假、无资产假、记录入井工数、工伤假、延时工数、计薪法定节假日天数、货币化住房补助。已更新相关的规则文档和模板说明。

- **Q**: 如何重新设计数据导入导出表？
- **A**: 已根据用户提供的Excel参考文件重新设计数据导入导出规范：
  - **数据导入参考**: `dataSubmissionReport.xlsx` - 用于导入员工基础数据和考勤数据
  - **数据导出参考**: `dataExportReport.xlsx` - 用于导出员工基础信息
  - **薪资核算结果导出参考**: `payrollCalculationResultExportReport.xlsx` - 用于导出薪资计算结果（包含 payrollCalculationResult 工作表）
  - **文件位置**: 用户提供的参考文件位于 `C:\Users\Espen\Desktop\` 目录下，模板文件应存放在项目的 `excel-templates` 目录中
  - 所有相关文档已更新以反映新的表格结构，包括功能需求、用户故事、关键实体等部分

- **Q**: 数据导入导出表有重复内容如何处理？
- **A**: 当前三个表格存在部分重复内容，按照用户提供的表格内容进行文档整理。模板文件将基于这些参考文件进行优化，用户将在后期优化表格结构，届时将根据优化后的表格再次调整相关文档。

- **Q**: 是否需要保教费和取暖补贴项目？
- **A**: 根据用户要求，已删除税后项目区中的"保教费"和"取暖补贴"项目。所有相关文档已更新，包括：
  - 薪资数据导出格式说明文档 (export-02-功能规格说明书.md)
  - 薪资计算逻辑文档 (43-薪资计算逻辑.md)
  - 薪资变量定义文档 (44-薪资变量定义.md)
  当前税后项目仅包含：独生子女费、女工卫生费

- **Q**: 是否需要税后补发和税后补扣项目？
- **A**: 根据用户要求，已删除税后项目区中的"税后补发"和"税后补扣"项目。所有相关文档已更新，包括：
  - 薪资计算逻辑文档 (43-薪资计算逻辑.md) - 从实领工资公式中删除
  - 薪资数据导出格式说明文档 (export-02-功能规格说明书.md) - 删除相关列
  - 薪资变量定义文档 (44-薪资变量定义.md) - 删除变量定义
  - Web字段映射文档 (17-字段映射.md) - 更新计算公式
  当前税后项目仅包含：独生子女费、女工卫生费

- **Q**: 实领工资计算公式是否完整？
- **A**: 根据用户要求，已修正实领工资计算公式，添加个人所得税计算：
  - 完整公式：实领工资 = 应领工资 - 个人代扣代缴合计 - 个人所得税 + 独生子女费 + 女工卫生费
  - 个人所得税作为单独扣款项，在实领工资计算中扣除
  - 所有相关文档已更新，包括：
    - 薪资计算逻辑文档 (43-薪资计算逻辑.md)
    - 薪资数据导出格式说明文档 (export-02-功能规格说明书.md) - 添加个人所得税列，修正计算公式
    - 规格文档 (02-功能规格说明书.md) - 更新个人所得税相关说明

### Assumptions

- 初始版本专注于基本的薪资计算功能（基本薪资、奖金、扣款、加班费）
- 系统包含个人所得税和个人社保公积金的完整核算功能
- 个人所得税基于应领工资扣除社保后计算
- 当前版本不涉及复杂的税务合规性要求
