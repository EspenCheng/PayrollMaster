# 数据模型设计文档 - PayrollMaster薪资自动核算系统

## 概述

本文档定义了PayrollMaster系统的完整数据模型，包括所有实体、字段、关系和验证规则。数据模型基于PostgreSQL数据库，使用SQLModel ORM进行实现。

## 核心实体

### 1. 员工信息 (Employee)

存储员工基础信息和考勤数据，是薪资计算的基础。

```python
from sqlmodel import SQLModel, Field, Relationship
from typing import Optional, List
from datetime import datetime, date

class Employee(SQLModel, table=True):
    """员工基础信息模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    employeeId: str = Field(index=True, unique=True, description="员工工号")
    name: str = Field(description="员工姓名")
    department: str = Field(index=True, description="部门")
    position: str = Field(description="职位")
    basicSalary: float = Field(description="基本薪资", ge=0)
    hireDate: date = Field(description="入职日期")
    bankAccount: Optional[str] = Field(default=None, description="银行账号")
    idCard: Optional[str] = Field(default=None, description="身份证号")
    phone: Optional[str] = Field(default=None, description="联系电话")
    email: Optional[str] = Field(default=None, description="邮箱")

    # 考勤相关字段
    attendanceDays: int = Field(default=0, description="出勤天数")
    overtimeHours: float = Field(default=0, description="加班小时数")
    lateCount: int = Field(default=0, description="迟到次数")
    sickLeaveDays: int = Field(default=0, description="病假天数")
    personalLeaveDays: int = Field(default=0, description="事假天数")

    # 时间戳
    createdAt: datetime = Field(default_factory=datetime.now)
    updatedAt: datetime = Field(default_factory=datetime.now)

    # 关系
    salaryCalculations: List["SalaryCalculation"] = Relationship(back_populates="employee")

    class Config:
        json_schema_extra = {
            "example": {
                "employeeId": "EMP001",
                "name": "张三",
                "department": "技术部",
                "position": "高级工程师",
                "basicSalary": 15000.00,
                "hireDate": "2020-01-15"
            }
        }
```

### 2. 薪资计算规则 (PayrollRule)

可配置的薪资计算规则模板，支持多种计算方式。

```python
class PayrollRule(SQLModel, table=True):
    """薪资计算规则模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    ruleName: str = Field(description="规则名称")
    ruleType: str = Field(description="规则类型：bonus/deduction/overtime/tax/insurance")

    # 计算配置
    calculationType: str = Field(description="计算类型：fixed/percentage/formula")
    value: Optional[float] = Field(default=None, description="固定金额或百分比值")
    formula: Optional[str] = Field(default=None, description="自定义计算公式")

    # 条件配置
    conditionField: Optional[str] = Field(default=None, description="条件字段名")
    conditionOperator: Optional[str] = Field(default=None, description="条件操作符：>/</=/>=/<=/!=/in")
    conditionValue: Optional[str] = Field(default=None, description="条件值")

    # 状态
    isActive: bool = Field(default=True, description="是否启用")
    description: Optional[str] = Field(default=None, description="规则描述")

    createdAt: datetime = Field(default_factory=datetime.now)
    updatedAt: datetime = Field(default_factory=datetime.now)

    class Config:
        json_schema_extra = {
            "example": {
                "ruleName": "绩效奖金",
                "ruleType": "bonus",
                "calculationType": "percentage",
                "value": 10.0,
                "description": "按基本薪资的10%计算绩效奖金"
            }
        }
```

### 3. 薪资计算结果 (SalaryCalculation)

存储每次薪资计算的详细结果。

```python
class SalaryCalculation(SQLModel, table=True):
    """薪资计算结果模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    employeeId: int = Field(foreign_key="employee.id", index=True, description="员工ID")
    calculationDate: date = Field(index=True, description="计算日期（薪资周期）")

    # 基本薪资
    basicSalary: float = Field(description="基本薪资")

    # 奖金项目
    performanceBonus: float = Field(default=0, description="绩效奖金")
    overtimePay: float = Field(default=0, description="加班费")
    otherBonus: float = Field(default=0, description="其他奖金")

    # 扣除项目
    lateDeduction: float = Field(default=0, description="迟到扣款")
    sickLeaveDeduction: float = Field(default=0, description="病假扣款")
    personalLeaveDeduction: float = Field(default=0, description="事假扣款")
    otherDeduction: float = Field(default=0, description="其他扣款")

    # 社保公积金（个人部分）
    pensionInsurance: float = Field(default=0, description="养老保险")
    medicalInsurance: float = Field(default=0, description="医疗保险")
    unemploymentInsurance: float = Field(default=0, description="失业保险")
    housingFund: float = Field(default=0, description="住房公积金")

    # 税前应发
    grossPay: float = Field(description="应发工资")
    totalDeductions: float = Field(description="扣除合计")

    # 个人所得税
    personalIncomeTax: float = Field(default=0, description="个人所得税")

    # 税后项目
    onlyChildAllowance: float = Field(default=0, description="独生子女费")
    womenHealthAllowance: float = Field(default=0, description="女工卫生费")

    # 实发工资
    netPay: float = Field(description="实发工资")

    # 状态
    status: str = Field(default="draft", description="状态：draft/confirmed/paid")
    confirmedBy: Optional[str] = Field(default=None, description="确认人")
    confirmedAt: Optional[datetime] = Field(default=None, description="确认时间")
    notes: Optional[str] = Field(default=None, description="备注")

    createdAt: datetime = Field(default_factory=datetime.now)
    updatedAt: datetime = Field(default_factory=datetime.now)

    # 关系
    employee: Optional[Employee] = Relationship(back_populates="salaryCalculations")

    class Config:
        json_schema_extra = {
            "example": {
                "employeeId": 1,
                "calculationDate": "2025-12-31",
                "basicSalary": 15000.00,
                "performanceBonus": 1500.00,
                "grossPay": 16500.00,
                "totalDeductions": 2500.00,
                "netPay": 13500.00
            }
        }
```

### 4. 用户账号 (User)

系统用户和认证信息。

```python
class User(SQLModel, table=True):
    """用户账号模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(index=True, unique=True, description="用户名")
    email: str = Field(index=True, unique=True, description="邮箱")
    hashedPassword: str = Field(description="加密密码")
    fullName: str = Field(description="姓名")
    role: str = Field(index=True, description="角色：admin/manager/accountant/employee")

    # 权限
    isActive: bool = Field(default=True, description="是否激活")
    isSuperuser: bool = Field(default=False, description="是否超级管理员")

    # 时间戳
    lastLogin: Optional[datetime] = Field(default=None, description="最后登录时间")
    createdAt: datetime = Field(default_factory=datetime.now)
    updatedAt: datetime = Field(default_factory=datetime.now)

    class Config:
        json_schema_extra = {
            "example": {
                "username": "admin",
                "email": "admin@company.com",
                "fullName": "系统管理员",
                "role": "admin"
            }
        }
```

### 5. 系统日志 (SystemLog)

记录所有关键操作，支持审计追踪。

```python
class SystemLog(SQLModel, table=True):
    """系统日志模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    userId: Optional[int] = Field(foreign_key="user.id", index=True, description="操作用户ID")
    action: str = Field(index=True, description="操作类型")
    resourceType: str = Field(index=True, description="资源类型")
    resourceId: Optional[int] = Field(default=None, description="资源ID")
    details: Optional[str] = Field(default=None, description="详细信息")
    ipAddress: Optional[str] = Field(default=None, description="IP地址")
    userAgent: Optional[str] = Field(default=None, description="用户代理")

    createdAt: datetime = Field(default_factory=datetime.now, index=True)

    class Config:
        json_schema_extra = {
            "example": {
                "action": "CREATE",
                "resourceType": "Employee",
                "details": "创建员工：张三"
            }
        }
```

### 6. 数据备份记录 (DataBackup)

数据备份和恢复记录。

```python
class DataBackup(SQLModel, table=True):
    """数据备份模型"""
    id: Optional[int] = Field(default=None, primary_key=True)
    backupName: str = Field(description="备份名称")
    backupType: str = Field(description="备份类型：manual/automatic")
    filePath: str = Field(description="备份文件路径")
    fileSize: int = Field(description="文件大小（字节）")
    recordCount: int = Field(description="记录数量")

    # 状态
    status: str = Field(default="pending", description="状态：pending/success/failed")
    errorMessage: Optional[str] = Field(default=None, description="错误信息")

    createdBy: Optional[int] = Field(foreign_key="user.id", description="创建人")
    createdAt: datetime = Field(default_factory=datetime.now)

    class Config:
        json_schema_extra = {
            "example": {
                "backupName": "2025-12-09-full-backup",
                "backupType": "automatic",
                "status": "success"
            }
        }
```

## 实体关系图

```
User (1) ←→ (N) SystemLog
User (1) ←→ (N) DataBackup

Employee (1) ←→ (N) SalaryCalculation

PayrollRule (N) → (1) SalaryCalculation  [通过规则应用]
```

## Excel字段映射

**⚠️ 重要说明**：Excel文件采用双层表头格式

### 员工数据导入格式

Excel文件的前两行作为表头，从第3行开始是实际数据：

| 行号 | 内容 | 说明 |
|------|------|------|
| 第1行 | 英文字段名 | 用于系统内部字段映射 |
| 第2行 | 中文字段名 | 用于用户界面显示 |
| 第3行开始 | 实际数据 | 员工记录 |

### 字段映射表

```python
EMPLOYEE_FIELD_MAPPING = {
    # 英文字段名 : 数据库字段名
    'employeeId': 'employeeId',
    'name': 'name',
    'department': 'department',
    'position': 'position',
    'basicSalary': 'basicSalary',
    'hireDate': 'hireDate',
    'bankAccount': 'bankAccount',
    'idCard': 'idCard',
    'phone': 'phone',
    'email': 'email',
    'attendanceDays': 'attendanceDays',
    'overtimeHours': 'overtimeHours',
    'lateCount': 'lateCount',
    'sickLeaveDays': 'sickLeaveDays',
    'personalLeaveDays': 'personalLeaveDays',
}

# 中文显示名称映射
CHINESE_FIELD_NAMES = {
    'employeeId': '员工工号',
    'name': '姓名',
    'department': '部门',
    'position': '职位',
    'basicSalary': '基本薪资',
    'hireDate': '入职日期',
    'bankAccount': '银行账号',
    'idCard': '身份证号',
    'phone': '联系电话',
    'email': '邮箱',
    'attendanceDays': '出勤天数',
    'overtimeHours': '加班小时数',
    'lateCount': '迟到次数',
    'sickLeaveDays': '病假天数',
    'personalLeaveDays': '事假天数',
}
```

### Excel解析示例

```python
def parseEmployeeExcel(worksheet):
    """
    解析员工Excel文件
    """
    # 读取字段映射（第1-2行）
    fieldMappings = {}
    chineseNames = {}

    for col in range(1, worksheet.maxColumn + 1):
        englishName = worksheet.cell(row=1, column=col).value
        chineseName = worksheet.cell(row=2, column=col).value
        dbField = EMPLOYEE_FIELD_MAPPING.get(englishName)

        if dbField:
            fieldMappings[col] = dbField
            chineseNames[dbField] = chineseName

    # 读取数据（第3行开始）
    employees = []
    for row in range(3, worksheet.maxRow + 1):
        employeeData = {}
        for col, dbField in fieldMappings.items():
            value = worksheet.cell(row=row, column=col).value
            employeeData[dbField] = value

        if any(employeeData.values()):  # 跳过空行
            employees.append(employeeData)

    return employees, chineseNames
```

## 验证规则

### 字段验证

1. **员工工号**：必须唯一，长度5-20字符，仅包含字母和数字
2. **邮箱**：必须符合RFC 5322标准格式
3. **薪资金额**：必须≥0，保留两位小数
4. **日期字段**：不能为未来日期（除入职日期外）
5. **员工ID**：删除员工前必须确保无相关薪资记录

### 业务规则验证

1. **薪资计算一致性**：
   - 实发工资 = 应发工资 - 个人代扣代缴合计 - 个人所得税 + 税后项目
   - 所有金额字段必须保留两位小数

2. **考勤数据合理性**：
   - 出勤天数 ≤ 当月工作日
   - 加班小时数 ≥ 0
   - 请假天数 ≥ 0

3. **权限控制**：
   - 只有admin角色可以创建/删除用户
   - 只有admin和manager可以访问薪资计算配置
   - 所有用户只能查看自己负责范围内的薪资数据

## 索引策略

### 主要索引

1. **Employee表**：
   - employee_id (唯一索引)
   - department (普通索引)
   - hire_date (普通索引)

2. **SalaryCalculation表**：
   - employee_id + calculation_date (复合索引，用于查询特定员工的薪资历史)
   - calculation_date (普通索引，用于按周期查询)
   - status (普通索引，用于筛选状态)

3. **User表**：
   - username (唯一索引)
   - email (唯一索引)
   - role (普通索引)

4. **SystemLog表**：
   - user_id (普通索引)
   - created_at (普通索引，用于时间范围查询)
   - action + resource_type (复合索引，用于审计查询)

## 数据完整性

### 外键约束

- `SalaryCalculation.employee_id` → `Employee.id`
- `SystemLog.user_id` → `User.id`
- `DataBackup.created_by` → `User.id`

### 唯一性约束

- `Employee.employee_id` 唯一
- `User.username` 唯一
- `User.email` 唯一

### 检查约束

- 所有金额字段 ≥ 0
- 日期字段格式正确
- 状态字段值在允许范围内

## 数据迁移

使用Alembic进行数据库版本管理，迁移脚本应包括：

1. 初始表结构创建
2. 索引创建
3. 基础数据插入（管理员账号、默认规则等）
4. 数据验证脚本

## 性能优化

### 查询优化

1. 使用预加载（selectinload）减少N+1查询
2. 分页查询限制返回数据量
3. 使用复合索引优化多条件查询

### 缓存策略

1. Redis缓存频繁查询的薪资规则
2. 缓存用户会话和权限信息
3. 缓存部门列表等基础数据

### 并发控制

1. 使用数据库事务保证数据一致性
2. 乐观锁防止并发修改冲突
3. 薪资计算使用排他锁避免重复计算
